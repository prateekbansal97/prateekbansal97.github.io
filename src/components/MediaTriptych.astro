---
/**
 * Props:
 *  - id?: string                // anchor id (default "featured")
 *  - title?: string             // section heading (default "Featured")
 *  - covers: [{ src, title, caption, alt?, link? }, { ... }]
 *  - video: { src, poster?, title?, caption? }
 *  - aspect?: string            // if set, fixed-tile mode
 *  - height?: string            // if set, fixed-tile mode
 *  - fit?: "cover" | "contain"  // in fixed-tile mode
 */
const {
  id = 'featured',
  title = 'Featured',
  covers = [],
  video = {},
  aspect = undefined,
  height = undefined,
  fit = 'cover'
} = Astro.props;

const c0 = covers[0];
const c1 = covers[1];
const vidId = `v-${Math.random().toString(36).slice(2, 8)}`;

const galleryMode = !aspect && !height;
const fitClass = fit === 'contain' ? 'object-contain bg-black/5 dark:bg-white/5' : 'object-cover';
const boxStyle = aspect ? `aspect-ratio:${aspect}` : height ? `height:${height}` : '';
---
<section id={id} class="mt-12">
  <h2 class="text-2xl font-semibold">{title}</h2>

  <div class="mt-4 grid gap-4 md:grid-cols-3 items-stretch">
    {c0 && (
      <figure class="card overflow-hidden p-0">
        <a href={c0.link || c0.src} target="_blank" rel="noopener" class="block" style={galleryMode ? undefined : boxStyle}>
          <img src={c0.src} alt={c0.alt || c0.title || 'Cover'} class={galleryMode ? 'w-full h-auto block' : `h-full w-full ${fitClass} block`} loading="lazy" decoding="async" />
        </a>
        <figcaption class="p-3">
          <div class="font-medium">{c0.title}</div>
          {c0.caption && <div class="text-sm text-[color:var(--muted)]">{c0.caption}</div>}
        </figcaption>
      </figure>
    )}

    {c1 && (
      <figure class="card overflow-hidden p-0">
        <a href={c1.link || c1.src} target="_blank" rel="noopener" class="block" style={galleryMode ? undefined : boxStyle}>
          <img src={c1.src} alt={c1.alt || c1.title || 'Cover'} class={galleryMode ? 'w-full h-auto block' : `h-full w-full ${fitClass} block`} loading="lazy" decoding="async" />
        </a>
        <figcaption class="p-3">
          <div class="font-medium">{c1.title}</div>
          {c1.caption && <div class="text-sm text-[color:var(--muted)]">{c1.caption}</div>}
        </figcaption>
      </figure>
    )}

    {video?.src && (
      <figure class="card overflow-hidden p-0">
        {galleryMode ? (
          <video
            id={vidId}
            class="w-full h-auto block"
            src={video.src}
            poster={video.poster || undefined}
            autoplay muted loop playsinline preload="metadata"
          ></video>
        ) : (
          <div class="block" style={boxStyle}>
            <video
              id={vidId}
              class={`h-full w-full ${fitClass} block`}
              src={video.src}
              poster={video.poster || undefined}
              autoplay muted loop playsinline preload="metadata"
            ></video>
          </div>
        )}
        {(video.title || video.caption) && (
          <figcaption class="p-3">
            {video.title && <div class="font-medium">{video.title}</div>}
            {video.caption && <div class="text-sm text-[color:var(--muted)]">{video.caption}</div>}
          </figcaption>
        )}
      </figure>
    )}
  </div>

  <script is:inline>
    const vid = document.getElementById({JSON.stringify(vidId)});
    if (vid) {
      const io = new IntersectionObserver((entries) => {
        for (const e of entries) {
          if (e.isIntersecting) vid.play().catch(() => {});
          else vid.pause();
        }
      }, { threshold: 0.25 });
      io.observe(vid);
    }
  </script>
</section>
