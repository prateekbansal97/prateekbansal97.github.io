---
/**
 * Props:
 *  - pub: { title, authors, venue, year, url?, pdf?, code?, citation? }
 *  - index?: number              // optional, to show # ordering
 *  - highlight?: string          // e.g., "Prateek Bansal" -> bold in authors
 */
const { pub, index, highlight = '' } = Astro.props;

function escapeHtml(s = '') {
  return String(s)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#39;');
}

function highlightAuthor(authors = '', needle = '') {
  if (!authors || !needle) return escapeHtml(authors);
  // case-insensitive replace of whole or partial match; keep it simple & safe
  const re = new RegExp(needle.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
  return escapeHtml(authors).replace(re, (m) => `<strong>${m}</strong>`);
}

const authorsHtml = highlightAuthor(pub.authors || '', highlight);
const hasLinks = !!(pub.pdf || pub.url || pub.code || pub.citation);
---
<li class="card p-5 h-full flex flex-col gap-3">
  <div class="flex items-start justify-between gap-3">
    {typeof index === 'number' && (
      <span class="text-xs px-2 py-0.5 rounded bg-black/5 dark:bg-white/10 text-[color:var(--muted)]">#{index}</span>
    )}
    <div class="ml-auto flex flex-wrap gap-2 text-xs">
      {pub.venue && <span class="rounded-full px-2 py-0.5 border border-black/10">{pub.venue}</span>}
      {pub.year && <span class="rounded-full px-2 py-0.5 border border-black/10">{pub.year}</span>}
    </div>
  </div>

  <h3 class="text-base font-semibold leading-snug">
    {pub.url ? (
      <a href={pub.url} class="hover:underline" target="_blank" rel="noopener">{pub.title}</a>
    ) : (
      pub.title
    )}
  </h3>

  {pub.authors && (
    <div class="text-sm text-[color:var(--muted)]" set:html={authorsHtml}></div>
  )}

  {hasLinks && (
    <div class="mt-1 flex flex-wrap gap-3 text-sm">
      {pub.pdf && <a class="underline" href={pub.pdf} target="_blank" rel="noopener">ðŸ“„ PDF</a>}
      {pub.url && <a class="underline" href={pub.url} target="_blank" rel="noopener">ðŸ”— Page</a>}
      {pub.code && <a class="underline" href={pub.code} target="_blank" rel="noopener">ðŸ’» Code</a>}
      {pub.citation && (
        <button
          class="underline"
          onclick={`navigator.clipboard.writeText(${JSON.stringify(pub.citation)}).then(()=>this.textContent='âœ… Copied').catch(()=>this.textContent='â§‰ BibTeX')`}
        >â§‰ BibTeX</button>
      )}
    </div>
  )}
</li>
